<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>D3 Collapsible Tree - Organization Structure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            gap: 20px;
            height: 100vh;
        }
        .editor-section {
            width: 30%;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 15px;
            overflow: hidden;
        }
        .viz-section {
            width: 70%;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        .CodeMirror {
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            font-size: 12px;
        }
        .editor-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }
        .render-btn {
            background-color: #4CAF50;
            color: white;
        }
        .render-btn:hover {
            background-color: #45a049;
        }
        .reset-btn {
            background-color: #f44336;
            color: white;
        }
        .reset-btn:hover {
            background-color: #da190b;
        }
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 12px;
            display: none;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #ddd;
        }
        .tab-button {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            color: #333;
        }
        .tab-button.active {
            background-color: white;
            border-bottom-color: #4CAF50;
            color: #4CAF50;
        }
        .tab-button:hover {
            background-color: #e0e0e0;
        }
        svg {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
            overflow: auto;
        }
        .node rect {
            cursor: pointer;
        }
        .node text {
            font-size: 11px;
            pointer-events: none;
        }
        .link {
            fill: none;
            stroke: #999;
            stroke-width: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="editor-section">
            <h3>Data Editor</h3>
            <div class="error-message" id="errorMessage"></div>
            <textarea id="dataEditor"></textarea>
            <div class="editor-buttons">
                <button class="render-btn" onclick="renderData()">Render</button>
                <button class="reset-btn" onclick="resetData()">Reset</button>
            </div>
        </div>

        <div class="viz-section">
            <h2 style="margin: 0 0 10px 0; text-align: center; color: #333;">Organization Structure</h2>
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('clients')">Clients</button>
                <button class="tab-button" onclick="switchTab('subscriptions')">Subscriptions</button>
                <button class="tab-button" onclick="switchTab('mapping')">Subscriptions â†’ Clients</button>
            </div>
            <svg id="diagram"></svg>
        </div>
    </div>

    <script>
        let defaultData = [
            { id: 1, name: 'IT', isClient: false, status: 'Active', parent_id: null },
            { id: 2, name: 'IT Admin', isClient: false, status: 'Active', parent_id: 1 },
            { id: 3, name: 'IT Agent', isClient: false, status: 'Active', parent_id: 1 },
            { id: 4, name: 'IT Employee', isClient: false, status: 'Active', parent_id: 1 },
            
            { id: 5, name: 'HR', isClient: false, status: 'Active', parent_id: null },
            { id: 6, name: 'HR Admin', isClient: false, status: 'Active', parent_id: 5 },
            { id: 7, name: 'HR Agent', isClient: false, status: 'Active', parent_id: 5 },
            { id: 8, name: 'HR Employee', isClient: false, status: 'Active', parent_id: 5 },

            { id: 9, name: 'Finance', isClient: false, status: 'Active', parent_id: null },
            { id: 10, name: 'Finance Admin', isClient: false, status: 'Active', parent_id: 9 },
            { id: 11, name: 'Finance Agent', isClient: false, status: 'Active', parent_id: 9 },
            { id: 12, name: 'Finance Employee', isClient: false, status: 'Active', parent_id: 9 },

            { id: 13, name: 'Amazon', isClient: true, status: 'Active', parent_id: null, subscribedWorkspaceIds: [1, 5, 9] },
            { id: 14, name: 'Amazon India', isClient: true, status: 'Active', parent_id: 13, subscribedWorkspaceIds: [] },
            { id: 15, name: 'Amazon USA', isClient: true, status: 'Active', parent_id: 13, subscribedWorkspaceIds: [] },
            { id: 16, name: 'Amazon UK', isClient: true, status: 'Active', parent_id: 13, subscribedWorkspaceIds: [] },
            { id: 17, name: 'Amazon Canada', isClient: true, status: 'Active', parent_id: 13, subscribedWorkspaceIds: [] },

            { id: 18, name: 'Apple', isClient: true, status: 'Active', parent_id: null, subscribedWorkspaceIds: [1, 5] },
            { id: 19, name: 'Apple India', isClient: true, status: 'Active', parent_id: 18, subscribedWorkspaceIds: [] },
            { id: 20, name: 'Apple USA', isClient: true, status: 'Active', parent_id: 18, subscribedWorkspaceIds: [] },
            { id: 21, name: 'Apple UK', isClient: true, status: 'Active', parent_id: 18, subscribedWorkspaceIds: [] },
            { id: 22, name: 'Apple Canada', isClient: true, status: 'Active', parent_id: 18, subscribedWorkspaceIds: [] }
        ];

        let allData = JSON.parse(JSON.stringify(defaultData));
        let currentTab = 'clients';
        let i = 0;
        let duration = 750;

        let editor = CodeMirror.fromTextArea(document.getElementById('dataEditor'), {
            mode: 'javascript',
            theme: 'default',
            lineNumbers: true,
            lineWrapping: true,
            indentUnit: 2,
            indentWithTabs: false,
            tabSize: 2
        });

        editor.setValue(JSON.stringify(defaultData, null, 2));
        editor.setSize('100%', '100%');

        function showError(message) {
            let errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function renderData() {
            hideError();
            try {
                let jsonStr = editor.getValue();
                allData = JSON.parse(jsonStr);
                
                if (!Array.isArray(allData)) {
                    throw new Error('Data must be an array');
                }

                renderVisualization(currentTab);
            } catch (error) {
                showError('Error: ' + error.message);
            }
        }

        function resetData() {
            hideError();
            allData = JSON.parse(JSON.stringify(defaultData));
            editor.setValue(JSON.stringify(defaultData, null, 2));
            renderVisualization(currentTab);
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-button').forEach(function(btn) {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            renderVisualization(tab);
        }

        function buildHierarchy(data) {
            let roots = data.filter(function(d) { return !d.parent_id; });
            let idMap = {};
            
            for (let k = 0; k < data.length; k++) {
                idMap[data[k].id] = data[k];
            }

            function buildNode(nodeData) {
                let children = data.filter(function(d) { return d.parent_id === nodeData.id; });
                let node = {
                    id: nodeData.id,
                    name: nodeData.name,
                    isClient: nodeData.isClient,
                    subscribedWorkspaceIds: nodeData.subscribedWorkspaceIds || [],
                    children: children.length > 0 ? [] : null
                };

                if (children.length > 0) {
                    for (let j = 0; j < children.length; j++) {
                        node.children.push(buildNode(children[j]));
                    }
                }

                return node;
            }

            let result = [];
            for (let i = 0; i < roots.length; i++) {
                result.push(buildNode(roots[i]));
            }
            return result;
        }

        function collapse(d) {
            if (d.children) {
                d._children = d.children;
                for (let i = 0; i < d._children.length; i++) {
                    collapse(d._children[i]);
                }
                d.children = null;
            }
        }

        function renderVisualization(tab) {
            d3.select('#diagram').selectAll('*').remove();

            let margin = { top: 20, right: 90, bottom: 30, left: 90 };
            let width = document.getElementById('diagram').parentElement.clientWidth - 40 - margin.left - margin.right;
            let height = document.getElementById('diagram').parentElement.clientHeight - 100 - margin.top - margin.bottom;

            let svg = d3.select('#diagram')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .append('g')
                .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

            let treemap = d3.tree().size([height, width]);
            let root, treeData;

            if (tab === 'clients') {
                let clientData = allData.filter(function(d) { return d.isClient; });
                let hierarchy = buildHierarchy(clientData);
                
                treeData = {
                    name: 'Clients',
                    children: hierarchy,
                    isClient: true
                };

                root = d3.hierarchy(treeData, function(d) {
                    return d.children;
                });

                root.x0 = height / 2;
                root.y0 = 0;
                if (root.children) {
                    for (let i = 0; i < root.children.length; i++) {
                        collapse(root.children[i]);
                    }
                }

            } else if (tab === 'subscriptions') {
                let subData = allData.filter(function(d) { return !d.isClient; });
                let hierarchy = buildHierarchy(subData);
                
                treeData = {
                    name: 'Subscriptions',
                    children: hierarchy,
                    isClient: false
                };

                root = d3.hierarchy(treeData, function(d) {
                    return d.children;
                });

                root.x0 = height / 2;
                root.y0 = 0;
                if (root.children) {
                    for (let i = 0; i < root.children.length; i++) {
                        collapse(root.children[i]);
                    }
                }

            } else if (tab === 'mapping') {
                // For mapping tab, use a different visualization - bipartite graph
                renderMappingVisualization(svg, width, height);
                return;
            }

            update(root);

            function renderMappingVisualization(svg, width, height) {
                // Get clients with subscriptions
                let clientsWithSubs = allData.filter(function(d) { 
                    return d.isClient && d.subscribedWorkspaceIds && d.subscribedWorkspaceIds.length > 0; 
                });

                // Get all subscriptions that are used by clients (including children)
                let usedSubscriptionIds = new Set();
                for (let i = 0; i < clientsWithSubs.length; i++) {
                    let client = clientsWithSubs[i];
                    for (let j = 0; j < client.subscribedWorkspaceIds.length; j++) {
                        usedSubscriptionIds.add(client.subscribedWorkspaceIds[j]);
                    }
                }

                // Get all subscriptions used (root + any children of used subscriptions)
                let allSubscriptions = allData.filter(function(d) { return !d.isClient; });
                let usedSubscriptions = [];
                
                for (let i = 0; i < allSubscriptions.length; i++) {
                    let sub = allSubscriptions[i];
                    if (usedSubscriptionIds.has(sub.id)) {
                        usedSubscriptions.push(sub);
                    }
                    // Also add children of used subscriptions
                    if (sub.parent_id && usedSubscriptionIds.has(sub.parent_id)) {
                        if (!usedSubscriptions.some(function(s) { return s.id === sub.id; })) {
                            usedSubscriptions.push(sub);
                        }
                    }
                }

                // Define unique colors for each client - randomized but deterministic
                let colorPalette = [
  "#FF5733",
  "#33C1FF",
  "#8D33FF",
  "#33FF57",
  "#FF33A8",
  "#FFD133",
  "#33FFD1",
  "#FF3333",
  "#3375FF",
  "#75FF33"
];

                // Shuffle colors deterministically based on data
                let shuffledColors = colorPalette.slice();
                for (let i = shuffledColors.length - 1; i > 0; i--) {
                    let seed = 0;
                    for (let j = 0; j < clientsWithSubs[0].name.length; j++) {
                        seed += clientsWithSubs[0].name.charCodeAt(j);
                    }
                    let jIdx = Math.floor(((seed * (i + 1)) % (i + 1)));
                    let temp = shuffledColors[i];
                    shuffledColors[i] = shuffledColors[jIdx];
                    shuffledColors[jIdx] = temp;
                }

                // Create nodes
                let nodes = [];
                let nodeMap = {};
                
                // Add subscription nodes on the left (only used ones)
                for (let i = 0; i < usedSubscriptions.length; i++) {
                    let node = {
                        id: usedSubscriptions[i].id,
                        name: usedSubscriptions[i].name,
                        isClient: false,
                        x: 100,
                        y: (i + 1) * (height / (usedSubscriptions.length + 1))
                    };
                    nodes.push(node);
                    nodeMap[node.id] = node;
                }

                // Add client nodes on the right with unique randomized colors
                for (let i = 0; i < clientsWithSubs.length; i++) {
                    let node = {
                        id: clientsWithSubs[i].id,
                        name: clientsWithSubs[i].name,
                        isClient: true,
                        color: shuffledColors[i],
                        x: width - 100,
                        y: (i + 1) * (height / (clientsWithSubs.length + 1))
                    };
                    nodes.push(node);
                    nodeMap[node.id] = node;
                }

                // Create links
                let links = [];
                for (let i = 0; i < clientsWithSubs.length; i++) {
                    let client = clientsWithSubs[i];
                    for (let j = 0; j < client.subscribedWorkspaceIds.length; j++) {
                        let subId = client.subscribedWorkspaceIds[j];
                        if (nodeMap[subId]) {
                            links.push({
                                source: nodeMap[subId],
                                target: nodeMap[client.id],
                                color: nodeMap[client.id].color
                            });
                        }
                    }
                }

                // Draw links first
                svg.selectAll('.mapping-link')
                    .data(links)
                    .enter()
                    .append('line')
                    .attr('class', 'mapping-link')
                    .attr('x1', function(d) { return d.source.x; })
                    .attr('y1', function(d) { return d.source.y; })
                    .attr('x2', function(d) { return d.target.x; })
                    .attr('y2', function(d) { return d.target.y; })
                    .attr('stroke', function(d) { return d.color; })
                    .attr('stroke-width', 2.5)
                    .attr('opacity', 0.7);

                // Draw nodes
                let nodeGroups = svg.selectAll('.mapping-node')
                    .data(nodes)
                    .enter()
                    .append('g')
                    .attr('class', 'mapping-node')
                    .attr('transform', function(d) { 
                        return 'translate(' + d.x + ',' + d.y + ')'; 
                    });

                nodeGroups.append('rect')
                    .attr('x', -35)
                    .attr('y', -16)
                    .attr('width', 70)
                    .attr('height', 32)
                    .attr('rx', 6)
                    .attr('ry', 6)
                    .attr('stroke-width', 2)
                    .attr('stroke', function(d) {
                        if (d.isClient) return d.color;
                        return '#0C2340';
                    })
                    .attr('fill', function(d) {
                        if (d.isClient) return d.color;
                        return '#0369A1';
                    })
                    .style('filter', 'drop-shadow(0 4px 6px rgba(0, 0, 0, 0.15))');

                nodeGroups.append('text')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('dy', '.35em')
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#FFFFFF')
                    .attr('font-weight', '600')
                    .attr('font-size', '12px')
                    .text(function(d) { 
                        return d.name; 
                    });

                // Add labels
                svg.append('text')
                    .attr('x', 100)
                    .attr('y', 30)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#374151')
                    .attr('font-weight', 'bold')
                    .attr('font-size', '14px')
                    .text('Subscriptions');

                svg.append('text')
                    .attr('x', width - 100)
                    .attr('y', 30)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#374151')
                    .attr('font-weight', 'bold')
                    .attr('font-size', '14px')
                    .text('Clients');
            }

            function update(source) {
                let nodes = treemap(root).descendants();
                let links = treemap(root).descendants().slice(1);

                for (let j = 0; j < nodes.length; j++) {
                    nodes[j].y = nodes[j].depth * 180;
                }

                let node = svg.selectAll('g.node').data(nodes, function(d) {
                    return d.id || (d.id = ++i);
                });

                let nodeEnter = node.enter()
                    .append('g')
                    .attr('class', 'node')
                    .attr('transform', function(d) {
                        return 'translate(' + source.y0 + ',' + source.x0 + ')';
                    })
                    .on('click', click);

                nodeEnter.append('rect')
                    .attr('rx', function(d) {
                        if (d.parent) return d.children || d._children ? 0 : 6;
                        return 8;
                    })
                    .attr('ry', function(d) {
                        if (d.parent) return d.children || d._children ? 0 : 6;
                        return 8;
                    })
                    .attr('stroke-width', function(d) {
                        return d.parent ? 2 : 0;
                    })
                    .attr('stroke', function(d) {
                        if (!d.parent) return 'none';
                        return d.children || d._children ? '#2C5282' : '#2F855A';
                    })
                    .attr('stroke-dasharray', function(d) {
                        return d.children || d._children ? '0' : '3';
                    })
                    .attr('stroke-opacity', function(d) {
                        return d.children || d._children ? '1' : '0.7';
                    })
                    .attr('x', -40)
                    .attr('y', -18)
                    .attr('width', 80)
                    .attr('height', 36)
                    .style('fill', function(d) {
                        if (!d.parent) return '#1F2937';
                        if (d.children || d._children) {
                            return d.data.isClient ? '#C84E1B' : '#0369A1';
                        }
                        return d.data.isClient ? '#DC2626' : '#0891B2';
                    })
                    .style('filter', 'drop-shadow(0 4px 6px rgba(0, 0, 0, 0.15))');

                nodeEnter.append('text')
                    .style('fill', '#FFFFFF')
                    .attr('dy', '.35em')
                    .attr('x', 0)
                    .attr('text-anchor', 'middle')
                    .attr('font-weight', '600')
                    .attr('font-size', '12px')
                    .text(function(d) {
                        return d.data.name;
                    });

                let nodeUpdate = nodeEnter.merge(node);

                nodeUpdate.transition()
                    .duration(duration)
                    .attr('transform', function(d) {
                        return 'translate(' + d.y + ',' + d.x + ')';
                    });

                let nodeExit = node.exit()
                    .transition()
                    .duration(duration)
                    .attr('transform', function(d) {
                        return 'translate(' + source.y + ',' + source.x + ')';
                    })
                    .remove();

                nodeExit.select('rect').style('opacity', 1e-6);
                nodeExit.select('text').style('fill-opacity', 1e-6);

                let link = svg.selectAll('path.link').data(links, function(d) {
                    return d.id;
                });

                let linkEnter = link.enter()
                    .insert('path', 'g')
                    .attr('class', 'link')
                    .attr('d', function(d) {
                        let o = { x: source.x0, y: source.y0 };
                        return diagonal(o, o);
                    });

                let linkUpdate = linkEnter.merge(link);

                linkUpdate.transition()
                    .duration(duration)
                    .attr('d', function(d) {
                        return diagonal(d, d.parent);
                    });

                let linkExit = link.exit()
                    .transition()
                    .duration(duration)
                    .attr('d', function(d) {
                        let o = { x: source.x, y: source.y };
                        return diagonal(o, o);
                    })
                    .remove();

                for (let k = 0; k < nodes.length; k++) {
                    nodes[k].x0 = nodes[k].x;
                    nodes[k].y0 = nodes[k].y;
                }

                function diagonal(s, d) {
                    let path = 'M ' + s.y + ' ' + s.x +
                        ' C ' + (s.y + d.y) / 2 + ' ' + s.x +
                        ', ' + (s.y + d.y) / 2 + ' ' + d.x +
                        ', ' + d.y + ' ' + d.x;
                    return path;
                }

                function click(event, d) {
                    if (d.children) {
                        d._children = d.children;
                        d.children = null;
                    } else {
                        d.children = d._children;
                        d._children = null;
                    }
                    update(d);
                }
            }
        }

        // Initialize
        renderVisualization('clients');
    </script>
</body>
</html>
